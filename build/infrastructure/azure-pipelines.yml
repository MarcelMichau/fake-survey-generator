trigger: none

variables:
  isMain: $[eq(variables['Build.SourceBranch'], 'refs/heads/main')]

stages:
  - stage: Provisioning
    condition: and(succeeded(), eq(variables.isMain, true))
    displayName: "Provisioning"
    jobs:
      - job: Provisioning
        displayName: "Provision Infrastructure"
        pool:
          vmImage: "ubuntu-latest"

        variables:
          azureResourceManagerConnection: "Azure Service Connection"
          resourceGroupName: "rg-fake-survey-generator"
          location: "South Africa North"
          sqlAzureAdAdministratorLogin: "SQL Server Administrators"
          sqlAzureAdAdministratorObjectId: "7accb81c-4513-4df6-9eb7-791ac78e8fdb"

        steps:
          - task: AzureCLI@2
            displayName: "Deploy Bicep Template"
            inputs:
              azureSubscription: "Azure Service Connection"
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: >-
                az deployment sub create --template-file infra/main.bicep
                --location "$(location)"
                --parameters
                location="$(location)"
                resourceGroupName="$(resourceGroupName)"
                sqlAzureAdAdministratorLogin="$(sqlAzureAdAdministratorLogin)"
                sqlAzureAdAdministratorObjectId="$(sqlAzureAdAdministratorObjectId)"
